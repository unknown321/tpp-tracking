DOWNLOADER=/tmp/DepotDownloader
USERNAME=
DICT=/media/ssd/dev/mgs/datfpk/dictionary.txt

APPID=287700
DEPOT=287701
IMAGE=johnnymorganz/stylua:2.1.0
# IMAGE=stylua:2.1.0 # local build

# https://steamdb.info/depot/287701/history/
manifests=( 
#   first 00.dat appearance
    "7339993741433940557_2015-09-14T01:40:05+00:00" \
    "4095171774592044207_2015-09-24T05:25:18+00:00" \
    "392536111305778195_2015-10-06T06:03:46+00:00" \
    "8584388492042469039_2015-10-19T08:40:59+00:00" \
    "6758963654264051546_2015-10-20T08:09:10+00:00" \
    "7441694305992817734_2015-10-23T10:56:13+00:00" \
    "8865722280317036288_2015-10-29T03:51:50+00:00" \
    "4352269670155549857_2015-11-04T02:27:06+00:00" \
    "937408379476386669_2015-11-10T06:05:54+00:00" \
    "6831993509865715077_2015-11-16T03:44:02+00:00" \
    "4197015944444634950_2015-12-17T06:04:03+00:00" \
    "442078918407911593_2016-01-19T06:14:28+00:00" \
    "8217445149191554484_2016-01-21T07:44:30+00:00" \
    "6063246495344834431_2016-02-04T02:10:22+00:00" \
    "8415158531138510424_2016-02-17T04:21:13+00:00" \
    "2900417258126805915_2016-03-15T06:08:03+00:00" \
    "722687471597618314_2016-04-07T04:03:46+00:00" \
    "4632045317450795327_2016-05-10T05:13:43+00:00" \
    "7393967644472233689_2016-08-02T03:59:47+00:00" \
    "5340614488951530561_2016-10-11T06:04:55+00:00" \
    "943119167837862700_2016-11-15T06:00:41+00:00" \
    "1961674897376185566_2017-08-01T06:04:09+00:00" \
    "8082713845434665438_2017-08-22T06:02:01+00:00" \
    "4201702512006165679_2018-07-24T06:06:03+00:00" \
    "3864258051026719321_2018-08-03T06:08:14+00:00" \
    "1041935908423355448_2018-09-04T06:01:30+00:00" \
    "1571949338766793227_2018-11-06T06:01:24+00:00" \
    "1345014682290952729_2019-10-29T06:07:08+00:00" \
    "5134963791992431862_2021-02-09T06:03:59+00:00" \
    "2518831260221836800_2021-03-23T07:29:37+00:00" \
#    ===
#    ["7298946272394009999_2015-09-08T09:43:50+00:00"
#    ["7044904432373616336_2015-09-07T02:11:09+00:00"
#    ["4691442569168175942_2015-09-03T11:59:10+00:00"
#    ["8211872047025774467_2015-09-02T05:14:15+00:00"
#    ["1169535579591939527_2015-09-01T04:01:47+00:00"
 )
prefix=depots/287701/6239679/
files=( master/0/00.dat master/1/MGSVTUPDATEV0110/0/00.dat master/1/MGSVTUPDATEV0110/0/01.dat master/0/01.dat )


#rm -rf .git
#git init .

for mf in ${manifests[@]}; do
    echo ${mf}
    mfid=${mf%_*} # ABCDE
    datetime=${mf#*_} # 12345
    ${DOWNLOADER} -app ${APPID} -depot ${DEPOT} -manifest ${mfid} -filelist ./filelist.txt -username ${USERNAME} -remember-password
    rm -rf master
    for f in "${files[@]}"; do
        if ! test -f "${prefix}${f}"; then
            echo ${f} not exist
            continue
        fi

        mkdir -p $(dirname ${f})
        mv -v "${prefix}${f}" ${f}
        datfpk ${f} ${DICT}
        nn=$(echo ${f} | sed "s/\.dat/_dat/g")
        find ${nn} -name "*.fpk" -o -name "*.fpkd" -exec datfpk {} ${DICT} \;
        find ${nn} -name "*.lua" -exec bash -c "echo {}; docker run -v `pwd`:`pwd` -w `pwd` -it --rm ${IMAGE} /stylua {}" \;
        find ${nn} -name "*.fox2" -exec datfpk {} \;
    done
    git add master
    git commit -m "${datetime}, manifest ${mfid}"
done
